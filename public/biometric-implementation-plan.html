<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biometric Implementation Plan & Circuit Design</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <style>
        :root {
            --primary-color: #0056b3;
            --bg-color: #f4f4f9;
            --text-color: #333;
            --code-bg: #2d2d2d;
            --code-text: #f8f8f2;
        }
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: var(--primary-color);
        }
        h1 {
            text-align: center;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        h2 {
            border-left: 5px solid var(--primary-color);
            padding-left: 10px;
            margin-top: 40px;
             background-color: #e9ecef;
             padding: 10px;
        }
        
        /* Wiring Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: var(--primary-color);
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* Circuit Visualization */
        .circuit-diagram {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            background: #fff;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        /* Code Blocks */
        pre {
            background-color: var(--code-bg);
            color: var(--code-text);
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
        }
        .note {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-left: 5px solid #ffeeba;
            margin: 20px 0;
        }
        .step {
            margin-bottom: 20px;
        }
        .step-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

<div class="container">

    <h1>Attendro: Biometric Implementation Master Plan</h1>
    
    <p>
        This document serves as the master guide for implementing the <strong>Attendro</strong> biometric system. It covers the hardware wiring details, circuit logical design, database schema, and the firmware logic.
    </p>

    <!-- 1. HARDWARE SECTION -->
    <h2>1. Hardware Circuit Design</h2>
    <p>
        The core of the system is the <strong>ESP32 Dev Module</strong>. It acts as the brain, communicating with the <strong>R307 Fingerprint Sensor</strong> via UART (Serial) and providing visual feedback via an <strong>I2C OLED Display</strong>.
    </p>

    <h3>1.1 Component List</h3>
    <ul>
        <li>ESP32 Development Board (30-pin or 38-pin version)</li>
        <li>R307 Optical Fingerprint Sensor Module</li>
        <li>0.96 inch I2C OLED Display (SSD1306)</li>
        <li>Jumper Wires (Male-to-Male, Male-to-Female)</li>
        <li>Breadboard</li>
        <li>USB Data Cable</li>
    </ul>

    <h3>1.2 Wiring Diagram (Pin Connections)</h3>
    <div class="note">
        <strong>Important:</strong> The R307 sensor requires 5V to operate reliably, but its logic levels (TX/RX) are 3.3V compatible, making it perfect for ESP32.
    </div>

    <table>
        <thead>
            <tr>
                <th>Component</th>
                <th>Pin Name</th>
                <th>ESP32 Pin</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <!-- R307 Connections -->
            <tr>
                <td rowspan="4"><strong>R307 Fingerprint Sensor</strong></td>
                <td>VCC (Red)</td>
                <td>VIN (5V)</td>
                <td>Power Supply</td>
            </tr>
            <tr>
                <td>GND (Black)</td>
                <td>GND</td>
                <td>Ground</td>
            </tr>
            <tr>
                <td>TX (Green)</td>
                <td>GPIO 16 (RX2)</td>
                <td>Sensor Transmit -> ESP32 Receive</td>
            </tr>
            <tr>
                <td>RX (White)</td>
                <td>GPIO 17 (TX2)</td>
                <td>Sensor Receive <- ESP32 Transmit</td>
            </tr>
            
            <!-- OLED Connections -->
            <tr>
                <td rowspan="4"><strong>OLED Display</strong><br>(I2C Interface)</td>
                <td>VCC</td>
                <td>3.3V</td>
                <td>Power Supply (OLED usually 3.3V)</td>
            </tr>
            <tr>
                <td>GND</td>
                <td>GND</td>
                <td>Ground</td>
            </tr>
            <tr>
                <td>SCL</td>
                <td>GPIO 22</td>
                <td>I2C Clock Line</td>
            </tr>
            <tr>
                <td>SDA</td>
                <td>GPIO 21</td>
                <td>I2C Data Line</td>
            </tr>
        </tbody>
    </table>

    <h3>1.3 Schematic Visualization</h3>
    
    <!-- Virtual Circuit Visualization (SVG) -->
    <div class="circuit-diagram" style="display:block; text-align:center;">
        <h3>Virtual Wiring Diagram</h3>
        <p><em>(Visual representation of physical connections)</em></p>
        <svg width="800" height="500" viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg" style="background-color: #f8f9fa; border: 1px solid #ccc; border-radius: 8px;">
            
            <!-- DEFS for arrowheads or gradients if needed -->
            <defs>
                <marker id="arrow" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto" markerUnits="strokeWidth">
                  <path d="M0,0 L0,6 L9,3 z" fill="#f00" />
                </marker>
            </defs>

            <!-- ESP32 BOARD (Center) -->
            <g id="ESP32" transform="translate(300, 100)">
                <!-- Board PCB (Black) -->
                <rect x="0" y="0" width="200" height="320" rx="5" ry="5" fill="#1a1a1a" stroke="#000" stroke-width="1"/>
                
                <!-- USB Connector (Bottom) -->
                <rect x="70" y="315" width="60" height="15" fill="#silver" stroke="#555"/>

                <!-- WROOM-32 RF Shield (Silver) -->
                <rect x="40" y="20" width="120" height="140" fill="#dcdcdc" stroke="#999" stroke-width="1"/>
                
                <!-- Chip Label details -->
                <text x="100" y="60" fill="#333" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">ESP-WROOM-32</text>
                
                <!-- CE Logo simulation -->
                <text x="100" y="120" fill="#333" font-family="Arial" font-size="24" text-anchor="middle" font-weight="bold" opacity="0.3">CE</text>
                <circle cx="100" cy="112" r="26" stroke="#333" stroke-width="2" fill="none" opacity="0.3"/>

                <!-- Antenna Trace (Gold/Copper Zigzag at top) -->
                <path d="M 50 20 L 50 5 L 150 5 L 150 20" stroke="#1a1a1a" stroke-width="20" fill="none"/> <!-- Cutout background -->
                <polyline points="50,20 55,10 60,20 65,10 70,20 75,10 80,20" stroke="#b87333" stroke-width="1" fill="none"/>

                <!-- Board Name Label -->
                <text x="100" y="250" fill="#fff" font-family="Arial" font-size="16" text-anchor="middle" font-weight="bold">ESP32 DevKit V1</text>
                <text x="100" y="270" fill="#888" font-family="monospace" font-size="10" text-anchor="middle">WiFi + Bluetooth</text>

                <!-- EN and BOOT Buttons -->
                <rect x="20" y="280" width="20" height="10" fill="#333" stroke="#666"/>
                <text x="30" y="298" fill="#aaa" font-size="8" text-anchor="middle">EN</text>
                
                <rect x="160" y="280" width="20" height="10" fill="#333" stroke="#666"/>
                <text x="170" y="298" fill="#aaa" font-size="8" text-anchor="middle">BOOT</text>


                <!-- Left Pins (Top to Bottom) -->
                <!-- VIN (5V) -->
                <rect x="-15" y="40" width="15" height="15" fill="#d4af37" stroke="none"/>
                <text x="25" y="52" fill="white" font-size="11" font-family="monospace" font-weight="bold">VIN (5V)</text>
                
                <!-- GND -->
                <rect x="-15" y="70" width="15" height="15" fill="#d4af37" stroke="none"/>
                <text x="25" y="82" fill="white" font-size="11" font-family="monospace" font-weight="bold">GND</text>

                <!-- GPIO 16 (RX2) -->
                <rect x="-15" y="160" width="15" height="15" fill="#d4af37" stroke="none"/>
                <text x="25" y="172" fill="white" font-size="11" font-family="monospace" font-weight="bold">D16 (RX2)</text>

                <!-- GPIO 17 (TX2) -->
                <rect x="-15" y="190" width="15" height="15" fill="#d4af37" stroke="none"/>
                <text x="25" y="202" fill="white" font-size="11" font-family="monospace" font-weight="bold">D17 (TX2)</text>


                <!-- Right Pins (Top to Bottom) -->
                <!-- 3V3 -->
                <rect x="200" y="40" width="15" height="15" fill="#d4af37" stroke="none"/>
                <text x="175" y="52" fill="white" font-size="11" text-anchor="end" font-family="monospace" font-weight="bold">3V3</text>

                <!-- GND (Right side) -->
                <rect x="200" y="70" width="15" height="15" fill="#d4af37" stroke="none"/>
                <text x="175" y="82" fill="white" font-size="11" text-anchor="end" font-family="monospace" font-weight="bold">GND</text>

                <!-- GPIO 22 (SCL) -->
                <rect x="200" y="130" width="15" height="15" fill="#d4af37" stroke="none"/>
                <text x="175" y="142" fill="white" font-size="11" text-anchor="end" font-family="monospace" font-weight="bold">D22 (SCL)</text>

                <!-- GPIO 21 (SDA) -->
                <rect x="200" y="160" width="15" height="15" fill="#d4af37" stroke="none"/>
                <text x="175" y="172" fill="white" font-size="11" text-anchor="end" font-family="monospace" font-weight="bold">D21 (SDA)</text>
            </g>


            <!-- R307 SENSOR (Left) -->
            <g id="R307" transform="translate(20, 100)">
                <rect x="0" y="0" width="120" height="160" rx="5" ry="5" fill="#ddd" stroke="#999" stroke-width="2"/>
                <!-- Sensor Window -->
                <rect x="30" y="20" width="60" height="80" rx="2" ry="2" fill="#444"/>
                <rect x="35" y="25" width="50" height="70" fill="#22aa22" opacity="0.3"/> <!-- Green light simulation -->
                <text x="60" y="140" fill="#333" font-family="Arial" font-size="14" text-anchor="middle" font-weight="bold">R307 Sensor</text>

                <!-- Wires coming out -->
                <!-- VCC (Red) -->
                <circle cx="120" cy="40" r="5" fill="red"/>
                <text x="110" y="45" text-anchor="end" font-size="10">VCC</text>
                
                <!-- GND (Black) -->
                <circle cx="120" cy="70" r="5" fill="black"/>
                <text x="110" y="75" text-anchor="end" font-size="10">GND</text>

                <!-- TX (Green) -->
                <circle cx="120" cy="100" r="5" fill="green"/>
                <text x="110" y="105" text-anchor="end" font-size="10">TX</text>

                <!-- RX (White) -->
                <circle cx="120" cy="130" r="5" fill="white" stroke="black"/>
                <text x="110" y="135" text-anchor="end" font-size="10">RX</text>
            </g>


            <!-- OLED DISPLAY (Right) -->
            <g id="OLED" transform="translate(600, 100)">
                <rect x="0" y="0" width="150" height="120" fill="#111" stroke="#555" stroke-width="4"/>
                <rect x="10" y="30" width="130" height="80" fill="#000"/> <!-- Screen -->
                <text x="75" y="20" fill="#fff" font-family="Arial" font-size="12" text-anchor="middle">OLED 0.96"</text>
                <text x="75" y="70" fill="#0ff" font-family="monospace" font-size="14" text-anchor="middle">Ready...</text>

                <!-- Pins on Top of OLED (Usually they are at top) -->
                <g transform="translate(20, 0)">
                    <!-- GND -->
                    <rect x="10" y="-10" width="10" height="10" fill="#d4af37"/>
                    <text x="15" y="-15" text-anchor="middle" font-size="10">GND</text>
                    
                    <!-- VCC -->
                    <rect x="40" y="-10" width="10" height="10" fill="#d4af37"/>
                    <text x="45" y="-15" text-anchor="middle" font-size="10">VCC</text>
                    
                    <!-- SCL -->
                    <rect x="70" y="-10" width="10" height="10" fill="#d4af37"/>
                    <text x="75" y="-15" text-anchor="middle" font-size="10">SCL</text>

                     <!-- SDA -->
                     <rect x="100" y="-10" width="10" height="10" fill="#d4af37"/>
                     <text x="105" y="-15" text-anchor="middle" font-size="10">SDA</text>
                </g>
            </g>


            <!-- WIRES (Bezier Curves) -->
            
            <!-- R307 VCC (Red) to ESP32 VIN -->
            <!-- From (140, 140) to (290, 120) adjusted for groups -->
            <!-- R307 VCC Group Loc: 20+120=140, 100+40=140 -->
            <!-- ESP32 VIN Group Loc: 300-10=290, 100+20=120 -->
            <path d="M 140 140 C 200 140, 200 125, 290 127" stroke="red" stroke-width="4" fill="none"/>

            <!-- R307 GND (Black) to ESP32 GND (Left) -->
            <!-- R307 GND: 140, 170 -->
            <!-- ESP32 GND Left: 290, 157 -->
            <path d="M 140 170 C 200 170, 200 157, 290 157" stroke="black" stroke-width="4" fill="none"/>

            <!-- R307 TX (Green) to ESP32 GPIO 16 (RX2) -->
            <!-- R307 TX: 140, 200 -->
            <!-- ESP32 GPIO 16: 290, 217 -->
            <path d="M 140 200 C 220 200, 220 217, 290 217" stroke="green" stroke-width="4" fill="none"/>

            <!-- R307 RX (White) to ESP32 GPIO 17 (TX2) -->
            <!-- R307 RX: 140, 230 -->
            <!-- ESP32 GPIO 17: 290, 247 -->
            <path d="M 140 230 C 220 230, 220 247, 290 247" stroke="#aaa" stroke-width="4" fill="none" stroke-dasharray="5,2"/>


            <!-- OLED WIRES -->
            
            <!-- OLED GND (Pin 1) to ESP32 GND (Right) -->
            <!-- OLED GND: 600+20+15 = 635, 100-5 = 95 -->
            <!-- ESP32 GND Right: 300+190+20 = 510, 100+50 = 157 centerish is 510, 157 -->
            <path d="M 635 90 C 635 50, 560 50, 510 157" stroke="black" stroke-width="4" fill="none" opacity="0.8"/>
            
            <!-- OLED VCC (Pin 2) to ESP32 3V3 (Right) -->
            <!-- OLED VCC: 665, 90 -->
            <!-- ESP32 3V3: 510, 127 -->
            <path d="M 665 90 C 665 40, 540 40, 510 127" stroke="red" stroke-width="4" fill="none" opacity="0.8"/>
            
            <!-- OLED SCL (Pin 3) to ESP32 GPIO 22 (Left pin group) -->
            <!-- Oh wait, SCL is GPIO 22 -->
            <!-- OLED SCL: 695, 90 -->
            <!-- ESP32 GPIO 22: 510, 187 -->
            <path d="M 695 90 C 695 187, 600 187, 510 187" stroke="orange" stroke-width="4" fill="none"/>
            
            <!-- OLED SDA (Pin 4) to ESP32 GPIO 21 -->
            <!-- OLED SDA: 725, 90 -->
            <!-- ESP32 GPIO 21: 510, 217 -->
            <path d="M 725 90 C 725 217, 600 217, 510 217" stroke="blue" stroke-width="4" fill="none"/>

        </svg>
    </div>

    <!-- Logic Flow Diagram -->
    <div class="circuit-diagram">
        <div class="mermaid">
            graph LR
                subgraph Power
                    USB[USB Power 5V]
                end

                subgraph ESP32 [ESP32 Controller]
                    ESP_5V[VIN (5V)]
                    ESP_3V3[3V3]
                    ESP_GND[GND]
                    ESP_RX2[GPIO 16 (RX2)]
                    ESP_TX2[GPIO 17 (TX2)]
                    ESP_SDA[GPIO 21 (SDA)]
                    ESP_SCL[GPIO 22 (SCL)]
                end

                subgraph R307 [R307 Sensor]
                    R_VCC[VCC]
                    R_GND[GND]
                    R_TX[TX]
                    R_RX[RX]
                end

                subgraph OLED [OLED Display]
                    O_VCC[VCC]
                    O_GND[GND]
                    O_SDA[SDA]
                    O_SCL[SCL]
                end

                USB --> ESP_5V
                
                %% Fingerprint Connections
                ESP_5V --> R_VCC
                ESP_GND --> R_GND
                R_TX --Green Wire--> ESP_RX2
                ESP_TX2 --White Wire--> R_RX

                %% OLED Connections
                ESP_3V3 --> O_VCC
                ESP_GND --> O_GND
                ESP_SDA --> O_SDA
                ESP_SCL --> O_SCL

                style ESP32 fill:#f9f,stroke:#333
                style R307 fill:#bbf,stroke:#333
                style OLED fill:#bfb,stroke:#333
        </div>
    </div>

    <!-- 2. SOFTWARE SECTION -->
    <h2>2. Software Implementation</h2>

    <h3>2.1 Database Setup (Supabase SQL)</h3>
    <p>Run the following SQL in your Supabase SQL Editor to create the necessary tables.</p>
    <pre>
-- 1. Create Students Table
CREATE TABLE students (
    student_id BIGINT PRIMARY KEY, -- This will match the FingerPrint ID (1-127)
    name TEXT NOT NULL,
    roll_number TEXT NOT NULL,
    batch TEXT NOT NULL
);

-- 2. Create Attendance Logs Table
CREATE TABLE attendance_logs (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    student_id BIGINT REFERENCES students(student_id),
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    status TEXT DEFAULT 'Present'
);

-- 3. Turn on Realtime for Logs (Crucial for Dashboard)
alter publication supabase_realtime add table attendance_logs;
    </pre>

    <h3>2.2 Firmware Logic (ESP32 / Arduino C++)</h3>
    <p>This is the pseudocode/logic structure for the `main.cpp` file on the ESP32.</p>
    
    <div class="step">
        <div class="step-title">Step 1: Libraries</div>
        <pre>
#include &lt;Adafruit_Fingerprint.h&gt;
#include &lt;Adafruit_SSD1306.h&gt;
#include &lt;WiFi.h&gt;
#include &lt;HTTPClient.h&gt;
        </pre>
    </div>

    <div class="step">
        <div class="step-title">Step 2: Main Loop Logic</div>
        <div class="mermaid">
            flowchart TD
                Start((Start)) --> Init[Init WiFi, Sensor, OLED]
                Init --> CheckFinger{Finger Placed?}
                
                CheckFinger -- No --> Idle[Show 'Place Finger']
                Idle --> CheckFinger
                
                CheckFinger -- Yes --> Image[Take Image]
                Image --> Convert[Convert to Template]
                Convert --> Search[Search DB ID]
                
                Search -- Found --> ID_Match[Get ID #]
                Search -- Not Found --> Error[Show 'Not Found']
                
                ID_Match --> Display[OLED: Welcome ID #]
                Display --> Upload[HTTP POST to Supabase]
                Upload --> Success{Upload OK?}
                
                Success -- Yes --> Done[OLED: 'Saved']
                Done --> CheckFinger
        </div>
    </div>

    <h3>2.3 Frontend Integration (React)</h3>
    <p>
        The dashboard listens to the `attendance_logs` table using Supabase Realtime subscriptions.
    </p>
    <pre>
// Example React Hook for Realtime Attendance
useEffect(() => {
  const channel = supabase
    .channel('public:attendance_logs')
    .on('postgres_changes', 
        { event: 'INSERT', schema: 'public', table: 'attendance_logs' }, 
        (payload) => {
           console.log('New Attendance:', payload.new);
           // Update state here to show new student instantly
           setLogs((prev) => [payload.new, ...prev]);
        }
    )
    .subscribe();

  return () => supabase.removeChannel(channel);
}, []);
    </pre>

    <h2>3. Deployment Checklist</h2>
    <ul>
        <li>[ ] <strong>Soldering:</strong> Ensure header pins are soldered correctly on the ESP32.</li>
        <li>[ ] <strong>Power Check:</strong> Use a multimeter to verify 5V at the R307 VCC pin.</li>
        <li>[ ] <strong>Sensor Test:</strong> Use the "enroll" example sketch to register your own finger first at ID #1.</li>
        <li>[ ] <strong>WiFi Config:</strong> Hardcode your hotspot credentials in the code for testing.</li>
        <li>[ ] <strong>Data Test:</strong> Trigger a manual insert in Supabase to see if the React dashboard updates.</li>
    </ul>

</div>

</body>
</html>
